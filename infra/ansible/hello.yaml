---
- name: Bootstrap hello cluster
  hosts: hello
  become: true
  tasks:
    - name: Set hostname
      ansible.builtin.hostname:
        name: "{{ inventory_hostname }}"

    - name: Add hostname to /etc/hosts
      ansible.builtin.lineinfile:
        path: /etc/hosts
        line: "127.0.1.1 {{ inventory_hostname }}"

    - name: Create resolved.conf.d directory
      ansible.builtin.file:
        path: /etc/systemd/resolved.conf.d
        state: directory

    - name: Disable systemd-resolved stub listener
      ansible.builtin.copy:
        content: |
          [Resolve]
          DNSStubListener=no
        dest: /etc/systemd/resolved.conf.d/nostub.conf

    - name: Point resolv.conf to real resolv.conf
      ansible.builtin.file:
        src: /run/systemd/resolve/resolv.conf
        dest: /etc/resolv.conf
        state: link
        force: true

    - name: Restart systemd-resolved
      ansible.builtin.systemd:
        name: systemd-resolved
        state: restarted

    - name: Install K3s
      ansible.builtin.shell: curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--resolv-conf /run/systemd/resolve/resolv.conf" sh -
      args:
        creates: /usr/local/bin/k3s

    - name: Make kubeconfig readable
      ansible.builtin.file:
        path: /etc/rancher/k3s/k3s.yaml
        mode: "0644"

    - name: Wait for K3s to be ready
      ansible.builtin.command: kubectl wait --for=condition=Ready node --all --timeout=120s
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Install Helm
      ansible.builtin.shell: curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      args:
        creates: /usr/local/bin/helm

    - name: Create argocd-manager ServiceAccount
      ansible.builtin.shell: |
        kubectl apply -f - <<'EOF'
        apiVersion: v1
        kind: ServiceAccount
        metadata:
          name: argocd-manager
          namespace: kube-system
        EOF
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Create argocd-manager ClusterRoleBinding
      ansible.builtin.shell: |
        kubectl apply -f - <<'EOF'
        apiVersion: rbac.authorization.k8s.io/v1
        kind: ClusterRoleBinding
        metadata:
          name: argocd-manager
        roleRef:
          apiGroup: rbac.authorization.k8s.io
          kind: ClusterRole
          name: cluster-admin
        subjects:
          - kind: ServiceAccount
            name: argocd-manager
            namespace: kube-system
        EOF
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Create argocd-manager long-lived token Secret
      ansible.builtin.shell: |
        kubectl apply -f - <<'EOF'
        apiVersion: v1
        kind: Secret
        metadata:
          name: argocd-manager-token
          namespace: kube-system
          annotations:
            kubernetes.io/service-account.name: argocd-manager
        type: kubernetes.io/service-account-token
        EOF
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Wait for token to be populated
      ansible.builtin.shell: |
        kubectl -n kube-system get secret argocd-manager-token -o jsonpath='{.data.token}' | base64 -d
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: argocd_token
      until: argocd_token.stdout | length > 0
      retries: 5
      delay: 2

    - name: Display argocd-manager token
      ansible.builtin.debug:
        msg: "ArgoCD manager token: {{ argocd_token.stdout }}"
